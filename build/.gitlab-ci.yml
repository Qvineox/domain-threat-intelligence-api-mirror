stages:
  - build
#  - test
#  - deploy

.dind_build_setup:
  image: docker/docker:25.0.2
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
  services:
    - name: docker:25.0.2-dind
      alias: docker
#      command: [ "--insecure-registry=gl-uib-registry.rgs.ru" ] # to escape .509 unknown issuer
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  tags:
    - docker
#  only:
#    refs:
#      - master

#build gateway docker image:
#  stage: build
#  extends: .dind_build_setup
#  variables:
#    IMAGE_TAG: $CI_REGISTRY_IMAGE/gateway:$CI_COMMIT_REF_SLUG
#  script:
#    - mkdir $CI_PROJECT_DIR/gateway/config/certificates
#    - cp $CERT $CI_PROJECT_DIR/gateway/config/certificates/cert.crt
#    - cp $CERT_PRIVATE_KEY $CI_PROJECT_DIR/gateway/config/certificates/key.key
#    - docker build -t $IMAGE_TAG ./gateway
#    - docker push $IMAGE_TAG
#  tags:
#    - docker-in-docker

build docker image:
  stage: build
  extends: .dind_build_setup
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE/domain_threat_intel:$CI_COMMIT_REF_SLUG
  script:
    - docker build -t $IMAGE_TAG ./build/docker/Dockerfile
  #    - docker push $IMAGE_TAG
  tags:
    - docker

#deploy to production:
#  when: manual
#  stage: deploy
#  before_script:
#    - docker ps
#    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
#  script:
#    - docker-compose pull # or pull $CI_REGISTRY_IMAGE/gateway:$CI_COMMIT_REF_SLUG
#    - docker-compose up -d
#  tags:
#    - deploy
#  only:
#    refs:
#      - master

